import re
from typing import Callable

from pydantic import BaseModel, ConfigDict


try:
    from mathruler.grader import extract_boxed_content, grade_answer
except Exception:
    extract_boxed_content = None
    grade_answer = None

from .native import NativeJudgerConfig, RouterJudgerConfig


def format_reward(predict_str: str) -> float:
    pattern = re.compile(r"<think>.*</think>.*\\boxed\{.*\}.*", re.DOTALL)
    match_result = re.fullmatch(pattern, predict_str)
    return 1.0 if match_result else 0.0


def acc_reward(predict_str: str, ground_truth: str, use_boxed: bool = True) -> float:
    if extract_boxed_content is None:
        raise ImportError("Please install mathruler by 'pip install mathruler pylatexenc'")
    if use_boxed:
        answer = extract_boxed_content(predict_str)
    else:
        answer = predict_str
    return 1.0 if grade_answer(answer, ground_truth) else 0.0


def compute_reward(response, label, extra_info) -> dict:
    format_score = extra_info["format_score"]
    use_boxed = extra_info["use_boxed"]
    acc = acc_reward(response, label, use_boxed)
    score = (1.0 - format_score) * acc + format_score * format_reward(response)
    return {"score": score, "acc": acc}


class _GEO3KJudgerDefaults(BaseModel):
    """Shared defaults for GEO3K native and router judger configs."""

    model_config = ConfigDict(arbitrary_types_allowed=True, extra="forbid")

    judger_name: str = "hiyouga/geometry3k"
    extra_info: dict = {"format_score": 0.1, "use_boxed": True}
    reward_handler: Callable = compute_reward


class GEO3KNativeJudgerConfig(_GEO3KJudgerDefaults, NativeJudgerConfig):
    """Configuration for the GEO3K native judger."""


class GEO3KRouterJudgerConfig(_GEO3KJudgerDefaults, RouterJudgerConfig):
    """Configuration for the GEO3K router judger."""

    num_ray_actors: int = 1
    num_cpus_per_actor: int = 1
    cpu_memory_per_actor: int = 1024**3

